name: AI Code Review

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write          # Add this for status checks
      actions: read            # Add this for reading workflow info

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better diffs

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install AI Code Reviewer
      run: |
        # Install dependencies directly since package isn't on PyPI yet
        pip install aiohttp anthropic openai pydantic PyYAML jsonschema tenacity asyncio-throttle requests

        # Install the code reviewer from current repo
        python -m pip install -e .

    - name: Get changed files
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # For PR: compare against base branch
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "base_sha=${BASE_SHA}" >> $GITHUB_OUTPUT
          echo "head_sha=${HEAD_SHA}" >> $GITHUB_OUTPUT
        else
          # For push: compare against previous commit
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
          echo "base_sha=${BASE_SHA}" >> $GITHUB_OUTPUT
          echo "head_sha=${HEAD_SHA}" >> $GITHUB_OUTPUT
        fi

    - name: Run AI Code Review
      id: code-review
      env:
        # Primary providers (set in repository secrets)
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

        # GitHub context
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.number }}

      run: |
        # Detect primary language
        LANG=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" -o -name "*.java" -o -name "*.go" -o -name "*.rs" | head -1 | sed 's/.*\.//')

        # Detect project type
        if [ -f "package.json" ]; then
          if grep -q "react-native" package.json; then
            PROJECT_TYPE="react-native"
          elif grep -q "next" package.json; then
            PROJECT_TYPE="nextjs"
          elif grep -q "react" package.json; then
            PROJECT_TYPE="react"
        else
            PROJECT_TYPE="nodejs"
          fi
        elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
          PROJECT_TYPE="python"
        elif [ -f "go.mod" ]; then
          PROJECT_TYPE="go"
        elif [ -f "Cargo.toml" ]; then
          PROJECT_TYPE="rust"
        else
          PROJECT_TYPE="general"
        fi

        echo "Detected language: $LANG, project type: $PROJECT_TYPE"

        # Run AI code review
        ai-code-reviewer \
          --base ${{ steps.changed-files.outputs.base_sha }} \
          --head ${{ steps.changed-files.outputs.head_sha }} \
          --provider auto \
          --language $LANG \
          --project-type $PROJECT_TYPE \
          --output json \
          --save-report review-results.json \
          --fail-on major || echo "Review completed with findings"

    - name: Upload review results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ai-code-review-results
        path: review-results.json

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          try {
            // Read review results
            const reviewData = JSON.parse(fs.readFileSync('review-results.json', 'utf8'));

            if (reviewData.length === 0) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
                body: '## ðŸ¤– AI Code Review\n\nâœ… **No issues found!** Your code looks good.'
              });
              return;
            }

            // Group findings by severity
            const critical = reviewData.filter(r => r.severity === 'critical');
            const major = reviewData.filter(r => r.severity === 'major');
            const minor = reviewData.filter(r => r.severity === 'minor');
            const info = reviewData.filter(r => r.severity === 'info');

            let comment = '## ðŸ¤– AI Code Review\n\n';

            // Summary
            comment += '### ðŸ“Š Summary\n';
            if (critical.length > 0) comment += `ðŸ”´ **Critical**: ${critical.length}\n`;
            if (major.length > 0) comment += `ðŸŸ  **Major**: ${major.length}\n`;
            if (minor.length > 0) comment += `ðŸŸ¡ **Minor**: ${minor.length}\n`;
            if (info.length > 0) comment += `â„¹ï¸ **Info**: ${info.length}\n`;

            // Top 5 most important findings
            const topFindings = [...critical, ...major, ...minor, ...info].slice(0, 5);

            if (topFindings.length > 0) {
              comment += '\n### ðŸ” Key Findings\n';

              topFindings.forEach((finding, index) => {
                const emoji = {
                  'critical': 'ðŸ”´',
                  'major': 'ðŸŸ ',
                  'minor': 'ðŸŸ¡',
                  'info': 'â„¹ï¸'
                }[finding.severity];

                comment += `\n**${index + 1}. ${emoji} ${finding.category.toUpperCase()}**\n`;
                comment += `ðŸ“ \`${finding.file}\` (lines ${finding.line_start}-${finding.line_end})\n`;
                comment += `ðŸ’¬ ${finding.message}\n`;

                if (finding.suggestion) {
                  comment += `ðŸ’¡ **Suggestion**: ${finding.suggestion}\n`;
                }

                if (finding.code_snippet) {
                  comment += `\`\`\`\n${finding.code_snippet}\n\`\`\`\n`;
                }
              });
            }

            if (reviewData.length > 5) {
              comment += `\n*... and ${reviewData.length - 5} more findings. Check the [full report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.*`;
            }

            comment += '\n\n---\n*Powered by AI Code Reviewer - Keeping your code clean and secure! ðŸš€*';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

          } catch (error) {
            console.log('No review results found or error reading file:', error);
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ¤– AI Code Review\n\nâš ï¸ **Review completed but no results found.** This might be due to no changes detected or configuration issues.'
            });
          }

    - name: Set status check
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          let state = 'success';
          let description = 'No issues found';

          try {
            const reviewData = JSON.parse(fs.readFileSync('review-results.json', 'utf8'));
            const critical = reviewData.filter(r => r.severity === 'critical').length;
            const major = reviewData.filter(r => r.severity === 'major').length;

            if (critical > 0) {
              state = 'failure';
              description = `${critical} critical issue(s) found`;
            } else if (major > 0) {
              state = 'failure';
              description = `${major} major issue(s) found`;
            } else if (reviewData.length > 0) {
              state = 'success';
              description = `${reviewData.length} minor/info issue(s) found`;
            }
          } catch (error) {
            state = 'error';
            description = 'Could not complete code review';
          }

          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: state,
            description: description,
            context: 'AI Code Review'
          });

    - name: Security scan (additional)
      if: contains(github.event.head_commit.message, '[security-scan]') || github.event_name == 'pull_request'
      run: |
        echo "ðŸ”’ Running additional security scan..."
        ai-code-reviewer \
          --base ${{ steps.changed-files.outputs.base_sha }} \
          --head ${{ steps.changed-files.outputs.head_sha }} \
          --provider auto \
          --fail-on critical \
          --language $LANG \
          --project-type security-focused \
          --save-report security-scan.json || true

            - name: Upload security scan
          if: contains(github.event.head_commit.message, '[security-scan]') || github.event_name == 'pull_request'
          uses: actions/upload-artifact@v4
          with:
            name: security-scan-results
            path: security-scan.json